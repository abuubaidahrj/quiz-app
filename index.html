<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multiplication Quiz</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      max-width: 600px;
      margin: auto;
    }
    .hidden { display: none; }
    .question { font-size: 24px; margin: 20px 0; }
    input[type=text], input[type=number], select, button {
      font-size: 18px; 
      padding: 10px; 
      margin: 8px 0; 
      width: 100%;
      box-sizing: border-box;
    }
    label { display: block; margin-top: 10px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #aaa; padding: 6px; text-align: left; font-size: 14px; }
    button { background: #007BFF; color: white; border: none; border-radius: 8px; cursor: pointer; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <div id="setup">
    <h2>Multiplication Quiz</h2>
    <label>Name: <input id="username" type="text" placeholder="Enter your name"></label>
    <label>Select range:</label>
    <select id="sifirRange" onchange="toggleCustomRange(this.value)">
      <option value="2-2">Sifir 2</option>
      <option value="2-3">Sifir 2‚Äì3</option>
      <option value="2-4">Sifir 2‚Äì4</option>
      <option value="2-5">Sifir 2‚Äì5</option>
      <option value="2-6">Sifir 2‚Äì6</option>
      <option value="2-7">Sifir 2‚Äì7</option>
      <option value="2-8">Sifir 2‚Äì8</option>
      <option value="2-9">Sifir 2‚Äì9</option>
      <option value="2-10">Sifir 2‚Äì10</option>
      <option value="2-11">Sifir 2‚Äì11</option>
      <option value="1-12">All 1‚Äì12</option>
      <option value="custom">Custom range‚Ä¶</option>
    </select>
    <div id="customRange" class="hidden">
      <label>Start: <input type="number" id="customStart" min="1" max="12" value="2"></label>
      <label>End: <input type="number" id="customEnd" min="1" max="12" value="5"></label>
    </div>
    <button onclick="startQuiz()">Start Quiz</button>
  </div>

  <div id="quiz" class="hidden">
    <h3 id="who"></h3>
    <div class="question" id="question"></div>
    <input id="answer" type="number" placeholder="Your answer">
    <button onclick="submitAnswer()">Submit</button>
    <div id="feedback"></div>
  </div>

  <div id="report" class="hidden">
    <h2>Quiz Report</h2>
    <div id="summary"></div>
    <h3>Details</h3>
    <table id="details"><thead>
      <tr><th>Question</th><th>Attempts</th><th>Wrong Answers (with time)</th><th>Final Time (s)</th></tr>
    </thead><tbody></tbody></table>
    <button id="mailto">üìß Send Report by Email</button>
  </div>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    // Initialize EmailJS with your public key
    (function(){
      emailjs.init("QsPisMt2TziUDjvSh"); // ‚úÖ your public key
    })();

    let state = { user:"", questions:[], i:0, startAll:0, records:[], wrongLog:[] };

    function $(id){ return document.getElementById(id); }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
    function toggleCustomRange(val){ $('customRange').classList.toggle('hidden', val!=='custom'); }

    function startQuiz(){
      state.user = $('username').value || "Anonymous";
      let start,end;
      if($('sifirRange').value==="custom"){
        start = parseInt($('customStart').value);
        end = parseInt($('customEnd').value);
      } else {
        [start,end] = $('sifirRange').value.split('-').map(Number);
      }
      if(isNaN(start)||isNaN(end)||start<1||end>12||start>end){ alert("Invalid range"); return; }
      state.questions = [];
      for(let n=start;n<=end;n++){
        for(let m=1;m<=12;m++){
          state.questions.push({a:n,b:m,answer:n*m});
        }
      }
      state.questions = shuffle(state.questions);
      state.i=0; state.records=[]; state.wrongLog=[]; state.startAll=performance.now();
      $('setup').classList.add('hidden'); $('quiz').classList.remove('hidden');
      $('who').innerText="Player: "+state.user;
      nextQ();
    }

    function nextQ(){
      if(state.i>=state.questions.length){ finish(); return; }
      state.cur=state.questions[state.i];
      state.curStart=performance.now();
      state.curWrongs=[];
      $('question').innerText=`${state.cur.a} x ${state.cur.b} = ?`;
      $('answer').value=""; $('feedback').innerText="";
    }

    function submitAnswer(){
      let val = parseInt($('answer').value);
      if(val===state.cur.answer){
        let time=(performance.now()-state.curStart)/1000;
        state.records.push({q:`${state.cur.a}x${state.cur.b}`, time, wrongs:state.curWrongs.slice()});
        state.i++; nextQ();
      } else {
        let elapsed=(performance.now()-state.curStart)/1000;
        state.curWrongs.push({attempt:val, time:elapsed});
        $('feedback').innerText = "Incorrect, try again!";
        $('answer').focus();
      }
    }

    function finish(){
      $('quiz').classList.add('hidden');
      $('report').classList.remove('hidden');
      let totalTime=(performance.now()-state.startAll)/1000;
      let avg= totalTime/state.records.length;
      $('summary').innerHTML=`<p><b>User:</b> ${state.user}</p>
        <p><b>Date:</b> ${new Date().toLocaleString()}</p>
        <p><b>Total time:</b> ${totalTime.toFixed(1)}s</p>
        <p><b>Average per question:</b> ${avg.toFixed(2)}s</p>`;

      let tbody=$('details').querySelector('tbody');
      tbody.innerHTML="";
      let sorted=[...state.records].sort((a,b)=>b.time-a.time).slice(0,30);
      for(let rec of sorted){
        let tr=document.createElement('tr');
        let wrongs=rec.wrongs.map(w=>`${w.attempt} @${w.time.toFixed(1)}s`).join(", ");
        tr.innerHTML=`<td>${rec.q}</td><td>${rec.wrongs.length+1}</td><td>${wrongs||"-"}</td><td>${rec.time.toFixed(1)}</td>`;
        tbody.appendChild(tr);
      }

      // ‚úÖ EmailJS integration with your Service + Template
      document.getElementById("mailto").onclick = function(){
        emailjs.send("service_6hzvm17", "template_808wesj", {
          user: state.user,
          date: new Date().toLocaleString(),
          total_time: totalTime.toFixed(1),
          avg_time: avg.toFixed(2),
          report: sorted.map(rec =>
            `${rec.q} | time: ${rec.time.toFixed(1)}s | wrongs: ${(rec.wrongs.map(w=>w.attempt)).join(",") || "0"}`
          ).join("\n")
        })
        .then(function(){
          alert("‚úÖ Report sent successfully!");
        }, function(error){
          alert("‚ùå Failed to send: " + JSON.stringify(error));
        });
      }
    }
  </script>
</body>
</html>